<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reconocimiento de Lenguaje de Señas</title>
    <link href="https://cdn.tailwindcss.com" rel="stylesheet">
    <link rel="stylesheet" href="/frontend/styles.css">
</head>

<body class="min-h-screen flex flex-col items-center justify-start py-10 text-white font-sans">
    <h1 class="text-5xl font-extrabold mb-10 text-center drop-shadow-lg">Reconocimiento de Lenguaje de Señas</h1>

    <div class="camera-container bg-white/10 backdrop-blur-md p-6 rounded-2xl shadow-2xl w-full max-w-lg transition-transform hover:scale-105">
        <h2 class="text-2xl font-semibold text-center mb-4">Cámara en tiempo real</h2>

        <div class="relative flex justify-center">
            <video id="video" width="420" height="320" autoplay class="rounded-xl shadow-md"></video>
            <canvas id="overlay" width="420" height="320" class="absolute top-0 left-0 rounded-xl pointer-events-none"></canvas>
        </div>

        <div class="flex justify-center mt-4 gap-4">
            <button id="toggleBtn" class="control-btn bg-yellow-400 text-black font-semibold py-2 px-6 rounded-xl hover:bg-yellow-500 transition">⏸Pausar</button>
            <button id="clearBtn" class="control-btn bg-red-400 text-black font-semibold py-2 px-6 rounded-xl hover:bg-red-500 transition">Limpiar</button>
        </div>

        <div id="livePrediction" class="text-center p-3 bg-white/20 rounded-xl text-black font-bold text-2xl shadow-inner mt-4">
            Señal detectada: <span id="predictionLive">–</span>
        </div>

        <div id="wordBox" class="text-center p-3 bg-white/20 rounded-xl text-black font-bold text-xl shadow-inner mt-4">
            Palabra formada: <span id="wordLive">–</span>
        </div>
    </div>

    <div class="bg-white/10 backdrop-blur-md p-6 rounded-2xl shadow-2xl w-full max-w-lg mt-10 transition-transform hover:scale-105">
        <h2 class="text-2xl font-semibold text-center mb-4">Sube una imagen</h2>
        <input type="file" id="fileInput" class="block w-full mb-4 rounded bg-white/20 p-2 text-black" accept="image/*">
        <div id="previewContainer" class="my-4 text-center hidden">
            <img id="previewImage" class="mx-auto rounded-xl shadow-md max-w-full" alt="Vista previa">
        </div>
        <button id="predictBtn" class="w-full bg-yellow-400 text-black font-semibold py-2 rounded-xl hover:bg-yellow-500 transition">Predecir</button>
        <div id="result" class="mt-4 p-3 bg-white/20 rounded-xl text-black hidden text-center shadow-inner">
            Predicción: <span id="prediction" class="font-bold text-lg"></span>
        </div>
    </div>

<script>
const video = document.getElementById("video");
const overlay = document.getElementById("overlay");
const ctx = overlay.getContext("2d");
const predictionLive = document.getElementById("predictionLive");
const wordLive = document.getElementById("wordLive");
const toggleBtn = document.getElementById("toggleBtn");
const clearBtn = document.getElementById("clearBtn");

let isPaused = false;
let currentWord = "";

navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => { video.srcObject = stream; })
    .catch(err => console.error("No se puede acceder a la cámara", err));

const predictLive = async () => {
    if (isPaused || video.readyState !== video.HAVE_ENOUGH_DATA) return;

    ctx.drawImage(video, 0, 0, overlay.width, overlay.height);

    overlay.toBlob(async (blob) => {
        const formData = new FormData();
        formData.append("file", blob, "frame.jpg");

        try {
            const response = await fetch("/predict", { method: "POST", body: formData });
            const data = await response.json();
            const pred = data.prediction || "–";
            predictionLive.textContent = pred;
            currentWord = data.word || currentWord;
            wordLive.textContent = currentWord || "–";
        } catch {
            predictionLive.textContent = "Error";
        }
    }, "image/jpeg");
};

toggleBtn.addEventListener("click", () => {
    isPaused = !isPaused;
    toggleBtn.textContent = isPaused ? "Reanudar" : "Pausar";
});

clearBtn.addEventListener("click", () => {
    currentWord = "";
    wordLive.textContent = "–";
});

setInterval(predictLive, 700);

const fileInput = document.getElementById("fileInput");
const predictBtn = document.getElementById("predictBtn");
const prediction = document.getElementById("prediction");
const result = document.getElementById("result");
let selectedFile = null;

fileInput.addEventListener("change", (e) => {
    selectedFile = e.target.files[0];
    if (selectedFile) {
        const reader = new FileReader();
        reader.onload = function(ev) {
            document.getElementById("previewImage").src = ev.target.result;
            document.getElementById("previewContainer").classList.remove("hidden");
        }
        reader.readAsDataURL(selectedFile);
    }
});

predictBtn.addEventListener("click", async (e) => {
    e.preventDefault();
    if (!selectedFile) return;

    const formData = new FormData();
    formData.append("file", selectedFile);

    predictBtn.textContent = "Procesando...";
    predictBtn.disabled = true;

    try {
        const response = await fetch("/predict", { method: "POST", body: formData });
        const data = await response.json();
        prediction.textContent = data.prediction || "Error";
        result.classList.remove("hidden");
    } catch {
        prediction.textContent = "Error de conexión";
        result.classList.remove("hidden");
    }

    predictBtn.textContent = "Predecir";
    predictBtn.disabled = false;
});
</script>
</body>
</html>